destination_dataset = "fenix_derived"
platform = "fenix"
owners = ["loines@mozilla.org"]  # optional; users getting notification if funnel run fails
version = "1"  # optional; default is set to 1

[funnels]

[funnels.onboarding_funnel]

friendly_name = "Firefox for Android Onboarding Funnel"
description = "Funnel Steps for Firefox for Android Onboarding"
steps = ["first_card",
         "second_card",
         "third_card",
         "onboarding_completed"
         ]

dimensions = ["funnel_id",
              "action",
              "element_type",
              "country",
              "locale",
              "android_version",
              "channel",
              "device_model",
              "device_manufacturer",
              "first_seen_date",
              "adjust_network",
              "adjust_campaign",
              "adjust_creative",
              "adjust_ad_group",
              "install_source",
              "repeat_first_month_user",
              "retained_week_2",
              "retained_week_4"
              ]

[steps.first_card]
friendly_name = "First Card"
description = "First Onboarding Card"
data_source = "onboarding_events"
where_expression = """
    `mozfun.map.get_key`(event_extra, 'sequence_position') = '1' AND
    event_name != 'completed' AND
    event_category = 'onboarding'
"""
join_previous_step_on = "client_info.client_id"
select_expression = "client_info.client_id"
aggregation = "count distinct"

[steps.second_card]
friendly_name = "Second Card"
description = "Impression on Second Onboarding Card"
data_source = "onboarding_events"
where_expression = """
    `mozfun.map.get_key`(event_extra, 'sequence_position') = '2' AND
    event_name != 'completed' AND
    event_category = 'onboarding'
"""
join_previous_step_on = "client_info.client_id"
select_expression = "client_info.client_id"
aggregation = "count distinct"

[steps.third_card]
friendly_name = "Third Card"
description = "Third Onboarding Card"
data_source = "onboarding_events"
where_expression = """
    `mozfun.map.get_key`(event_extra, 'sequence_position') = '3' AND
    event_name != 'completed' AND
    event_category = 'onboarding'
"""
join_previous_step_on = "client_info.client_id"
select_expression = "client_info.client_id"
aggregation = "count distinct"

[steps.onboarding_completed]
friendly_name = "Third Card"
description = "Third Onboarding Card"
data_source = "onboarding_events"
where_expression = """
    event_name = 'completed' AND
    event_category = 'onboarding'
"""
join_previous_step_on = "client_info.client_id"
select_expression = "client_info.client_id"
aggregation = "count distinct"

[data_sources]

[data_sources.onboarding_events]
from_expression = """
  fenix.events_unnested eu
  LEFT JOIN `moz-fx-data-shared-prod`.fenix_derived.funnel_retention_clients_week_4_v1 r
  ON eu.client_info.client_id = r.client_id
  LEFT JOIN fenix.firefox_android_clients ac
  ON eu.client_info.client_id = ac.client_id
"""

submission_date_column = "DATE(submission_timestamp)"
client_id_column = "client_info.client_id"


[dimensions]

# these dimensions are sourced from events_unnested
[dimensions.action]
data_source = "onboarding_events"
select_expression = "`mozfun.map.get_key`(event_extra, 'action')"
friendly_name = "Card Action"
description = "Action Taken on Card"
client_id_column = "eu.client_id"

[dimensions.funnel_id]
data_source = "onboarding_events"
select_expression = "`mozfun.map.get_key`(event_extra, 'sequence_id')"
friendly_name = "Funnel ID"
description = "ID of the Onboarding Funnel"
client_id_column = "eu.client_id"

[dimensions.element_type]
data_source = "onboarding_events"
select_expression = "`mozfun.map.get_key`(event_extra, 'element_type')"
friendly_name = "Element Type"
description = "Type of Card Element Interacted With"
client_id_column = "eu.client_id"

# these dimensions are sourced from funnel_retention_clients_week_4_v1
[dimensions.repeat_first_month_user]
friendly_name = "Repeat First Month User"
description = "Whether the Client is a Repeat First Month User"
data_source = "onboarding_events"
select_expression = "r.repeat_first_month_user"
client_id_column = "r.client_id"

[dimensions.retained_week_2]
friendly_name = "Repeat First Month User"
description = "Whether the Client is Retained in their Second Week"
data_source = "onboarding_events"
select_expression = "r.retained_week_2"
client_id_column = "r.client_id"

[dimensions.retained_week_4]
friendly_name = "Repeat First Month User"
description = "Whether the Client is Retained in their Fourth Week"
data_source = "onboarding_events"
select_expression = "r.retained_week_4"
client_id_column = "r.client_id"

# these dimensions are sourced from firefox_android_clients
[dimensions.country]
data_source = "onboarding_events"
select_expression = "ac.first_reported_country"
friendly_name = "Country"
description = "Client's First Reported Country"
client_id_column = "ac.client_id"

[dimensions.locale]
data_source = "onboarding_events"
select_expression = "ac.locale"
friendly_name = "Locale"
description = "Client's First Reported Language"
client_id_column = "ac.client_id"

[dimensions.android_version]
data_source = "onboarding_events"
select_expression = "ac.os_version"
friendly_name = "First Reported Android OS Version"
client_id_column = "ac.client_id"

[dimensions.channel]
data_source = "onboarding_events"
select_expression = "ac.channel"
friendly_name = "First Reported Release Channel"
client_id_column = "ac.client_id"

[dimensions.device_model]
data_source = "onboarding_events"
select_expression = "ac.device_model"
friendly_name = "First Reported Device Model"
client_id_column = "ac.client_id"

[dimensions.device_manufacturer]
data_source = "onboarding_events"
select_expression = "ac.device_manufacturer"
friendly_name = "First Reported Device Manufacturer"
client_id_column = "ac.client_id"

[dimensions.first_seen_date]
data_source = "onboarding_events"
select_expression = "ac.first_seen_date"
friendly_name = "First Seen Date"
description = "First day this client_id shows up in our data."
client_id_column = "ac.client_id"

[dimensions.adjust_network]
data_source = "onboarding_events"
select_expression = "ac.adjust_network"
friendly_name = "Adjust Network"
client_id_column = "ac.client_id"

[dimensions.adjust_campaign]
data_source = "onboarding_events"
select_expression = "ac.adjust_campaign"
friendly_name = "Adjust Campaign"
client_id_column = "ac.client_id"

[dimensions.adjust_creative]
data_source = "onboarding_events"
select_expression = "ac.adjust_creative"
friendly_name = "Adjust Creative"
client_id_column = "ac.client_id"

[dimensions.adjust_ad_group]
data_source = "onboarding_events"
select_expression = "ac.adjust_ad_group"
friendly_name = "Adjust Ad Group"
client_id_column = "ac.client_id"

[dimensions.install_source]
data_source = "onboarding_events"
select_expression = "ac.install_source"
friendly_name = "Install Source"
client_id_column = "ac.client_id"
