-- {{ header }}
{% if app_name == "firefox_desktop" %}
SELECT
  submission_timestamp,
  client_info.client_id,
  sample_id,
  metrics.uuid.messaging_system_client_id AS legacy_telemetry_client_id,
  metrics.text2.messaging_system_message_id,
  metrics.string.messaging_system_event,
  metrics.string.messaging_system_event_source,
  -- the events for the infobar are different than the events for the modal - this should standardize the modal events so they look like the infobar events
  CASE
    -- these are the infobar events or the events for which the infobar and modal are the same - treat them as-is
    WHEN metrics.string.messaging_system_event IN ("IMPRESSION", "CLICK_PRIMARY_BUTTON", "DISMISSED", "CLICK_SECONDARY_BUTTON") THEN metrics.string.messaging_system_event
    -- for the modal the modal DISMISS == DISMISSED
    WHEN metrics.string.messaging_system_event = "DISMISS" THEN "DISMISSED"
    WHEN metrics.string.messaging_system_event_source = "primary_button" THEN "CLICK_PRIMARY_BUTTON"
    WHEN metrics.string.messaging_system_event_source = "secondary_button" THEN "CLICK_SECONDARY_BUTTON"
    -- otherwise, its a privacy notice or other button click
    ELSE UPPER(REPLACE(metrics.string.messaging_system_event_source, "-", "_")
  ) END AS normalized_event,
  -- standardize the surface of the message. there are two message_ids for the blue infobar - collapse them.
  CASE
    WHEN metrics.text2.messaging_system_message_id LIKE "%infobar%" THEN "infobar"
    WHEN LOWER(metrics.text2.messaging_system_message_id) LIKE "%onboarding%" THEN "onboarding"
    ELSE "modal"
  END messaging_surface,
FROM
  `{{ project_id }}.{{ app_name }}.messaging_system`
WHERE
  DATE(submission_timestamp) = @submission_date
  AND (
    (UPPER(metrics.text2.messaging_system_message_id) LIKE "TOU%")
    OR (UPPER(metrics.text2.messaging_system_message_id) LIKE "TOS%")
    OR (UPPER(metrics.text2.messaging_system_message_id) LIKE "NEW_USER_TOU%")
  )
{% else %}
SELECT
  submission_timestamp,
  client_id,
  sample_id,
  event_timestamp,
  event_category,
  event_name,
  CASE
    WHEN (event_category = "onboarding" OR JSON_VALUE(event_extra.surface) = "onboarding") THEN "onboarding"
    ELSE
    {% if app_name == "firefox_ios" %}
      "bottom_sheet"
    {% else %}
      JSON_VALUE(event_extra.surface)
    {% endif %}
  END AS surface,
  CASE
    {% if app_name == "firefox_ios" %}
    WHEN (event_name = "accepted" AND JSON_VALUE(event_extra.surface) = "bottom_sheet") OR (event_name = "terms_of_service_accepted") THEN "accepted"
    {% else %}
    WHEN (event_name = "accepted") OR (event_name = "terms_of_service_accepted") THEN "accepted"
    {% endif %}
    WHEN event_name IN ("terms_of_service_card", "shown", "impression") THEN "impressions"
    WHEN event_name IN ("terms_of_service_privacy_notice_link_clicked", "privacy_notice_tapped", "privacy_notice_clicked") THEN "privacy_notice_clicked"
    WHEN event_name IN ("terms_of_service_link_clicked", "terms_of_use_link_tapped", "terms_of_use_click") THEN "terms_of_use_link_clicked"
    {% if app_name == "fenix" %}
    WHEN event_name IN ("dismiss") THEN "dismissed"
    {% endif %}
    ELSE event_name
  END AS normalized_event_name
FROM
    `{{ project_id }}.{{ app_name }}.events_stream`
WHERE
  DATE(submission_timestamp) = @submission_date
  AND DATE(submission_timestamp) >= "2025-03-01" -- when terms of use started getting rolled out.
  AND (
    event_category = "terms_of_use"
    OR (event_category = "onboarding" AND event_name LIKE "%terms_of_%")
  )
{% endif %}
