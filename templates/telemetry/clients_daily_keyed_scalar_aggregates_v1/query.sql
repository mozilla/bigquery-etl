-- Query generated by:
    -- templates/clients_daily_scalar_aggregates.sql.py --agg-type keyed-scalar
WITH
    -- normalize client_id and rank by document_id
    numbered_duplicates AS (
        SELECT
            ROW_NUMBER() OVER (
                PARTITION BY
                    client_id,
                    submission_date,
                    document_id
                ORDER BY `timestamp`
                ASC
            ) AS _n,
            * REPLACE(LOWER(client_id) AS client_id)
        FROM main_summary_v4
        WHERE submission_date = @submission_date
        AND channel in (
            "release", "esr", "beta", "aurora", "default", "nightly"
        )
        AND client_id IS NOT NULL
    ),


    -- Deduplicating on document_id is necessary to get valid SUM values.
    deduplicated AS (
        SELECT * EXCEPT (_n)
        FROM numbered_duplicates
        WHERE _n = 1
    ),

grouped_metrics AS
  (select
    timestamp,
    client_id,
    submission_date,
    os,
    app_version,
    app_build_id,
    channel,
    ARRAY<STRUCT<
        name STRING,
        value ARRAY<STRUCT<key STRING, value INT64>>
    >>[
        ('scalar_parent_gfx_advanced_layers_failure_id', scalar_parent_gfx_advanced_layers_failure_id),
        ('scalar_parent_resistfingerprinting_content_window_size', scalar_parent_resistfingerprinting_content_window_size),
        ('scalar_parent_devtools_tooltip_shown', scalar_parent_devtools_tooltip_shown),
        ('scalar_parent_browser_engagement_navigation_about_home', scalar_parent_browser_engagement_navigation_about_home),
        ('scalar_parent_update_bitshresult', scalar_parent_update_bitshresult),
        ('scalar_parent_networking_data_transferred_v3_kb', scalar_parent_networking_data_transferred_v3_kb),
        ('scalar_parent_devtools_accessibility_accessible_context_menu_item_activated', scalar_parent_devtools_accessibility_accessible_context_menu_item_activated),
        ('scalar_parent_preferences_use_current_page', scalar_parent_preferences_use_current_page),
        ('scalar_parent_extensions_updates_rdf', scalar_parent_extensions_updates_rdf),
        ('scalar_parent_telemetry_keyed_scalars_exceed_limit', scalar_parent_telemetry_keyed_scalars_exceed_limit),
        ('scalar_parent_pictureinpicture_closed_method', scalar_parent_pictureinpicture_closed_method),
        ('scalar_parent_browser_search_with_ads', scalar_parent_browser_search_with_ads),
        ('scalar_parent_security_webauthn_used', scalar_parent_security_webauthn_used),
        ('scalar_parent_devtools_inspector_three_pane_enabled', scalar_parent_devtools_inspector_three_pane_enabled),
        ('scalar_parent_browser_engagement_navigation_urlbar', scalar_parent_browser_engagement_navigation_urlbar),
        ('scalar_parent_devtools_current_theme', scalar_parent_devtools_current_theme),
        ('scalar_parent_telemetry_accumulate_unknown_histogram_keys', scalar_parent_telemetry_accumulate_unknown_histogram_keys),
        ('scalar_parent_qm_origin_directory_unexpected_filename', scalar_parent_qm_origin_directory_unexpected_filename),
        ('scalar_parent_browser_engagement_navigation_searchbar', scalar_parent_browser_engagement_navigation_searchbar),
        ('scalar_parent_devtools_toolbox_tabs_reordered', scalar_parent_devtools_toolbox_tabs_reordered),
        ('scalar_parent_update_binarytransparencyresult', scalar_parent_update_binarytransparencyresult),
        ('scalar_parent_telemetry_event_counts', scalar_parent_telemetry_event_counts),
        ('scalar_parent_devtools_accessibility_select_accessible_for_node', scalar_parent_devtools_accessibility_select_accessible_for_node),
        ('scalar_parent_browser_errors_collected_count_by_filename', scalar_parent_browser_errors_collected_count_by_filename),
        ('scalar_parent_preferences_browser_home_page_count', scalar_parent_preferences_browser_home_page_count),
        ('scalar_parent_preferences_search_query', scalar_parent_preferences_search_query),
        ('scalar_parent_preferences_browser_home_page_change', scalar_parent_preferences_browser_home_page_change),
        ('scalar_parent_browser_engagement_navigation_webextension', scalar_parent_browser_engagement_navigation_webextension),
        ('scalar_parent_devtools_responsive_open_trigger', scalar_parent_devtools_responsive_open_trigger),
        ('scalar_parent_browser_search_ad_clicks', scalar_parent_browser_search_ad_clicks),
        ('scalar_parent_devtools_accessibility_audit_activated', scalar_parent_devtools_accessibility_audit_activated),
        ('scalar_parent_browser_engagement_navigation_about_newtab', scalar_parent_browser_engagement_navigation_about_newtab),
        ('scalar_parent_networking_data_transferred_kb', scalar_parent_networking_data_transferred_kb),
        ('scalar_parent_storage_sync_api_usage_storage_consumed', scalar_parent_storage_sync_api_usage_storage_consumed),
        ('scalar_parent_normandy_recipe_freshness', scalar_parent_normandy_recipe_freshness),
        ('scalar_parent_browser_engagement_navigation_contextmenu', scalar_parent_browser_engagement_navigation_contextmenu),
        ('scalar_parent_storage_sync_api_usage_items_stored', scalar_parent_storage_sync_api_usage_items_stored),
        ('scalar_parent_images_webp_content_frequency', scalar_parent_images_webp_content_frequency),
        ('scalar_parent_security_client_cert', scalar_parent_security_client_cert),
        ('scalar_parent_preferences_use_bookmark', scalar_parent_preferences_use_bookmark),
        ('scalar_parent_telemetry_accumulate_clamped_values', scalar_parent_telemetry_accumulate_clamped_values)
    ] as metrics
  FROM deduplicated),

  flattened_metrics AS
    (SELECT
      timestamp,
      client_id,
      submission_date,
      os,
      app_version,
      app_build_id,
      channel,
      metrics.name AS metric,
      value.key AS key,
      value.value AS value
    FROM grouped_metrics
    CROSS JOIN unnest(metrics) AS metrics,
    unnest(metrics.value) AS value),


    -- Aggregate by client_id using windows
    windowed AS (
        SELECT
            ROW_NUMBER() OVER w1_unframed AS _n,
            submission_date,
            client_id,
            os,
            SPLIT(app_version, '.')[OFFSET(0)] AS app_version,
            app_build_id,
            channel,
            metric,
            key,
            MAX(value) OVER w1 as max,
            MIN(value) OVER w1 as min,
            AVG(value) OVER w1 as avg,
            SUM(value) OVER w1 as sum

        FROM flattened_metrics
        WINDOW
            -- Aggregations require a framed window
            w1 AS (
                PARTITION BY
                    client_id,
                    submission_date,
                    os,
                    app_version,
                    app_build_id,
                    channel
                    ,
                    metric,
                    key

                ORDER BY `timestamp` ASC ROWS BETWEEN UNBOUNDED PRECEDING
                AND UNBOUNDED FOLLOWING
            ),

            -- ROW_NUMBER does not work on a framed window
            w1_unframed AS (
                PARTITION BY
                    client_id,
                    submission_date,
                    os,
                    app_version,
                    app_build_id,
                    channel
                    ,
                    metric,
                    key

                ORDER BY `timestamp` ASC
            )
    )

select
    client_id,
    submission_date,
    os,
    app_version,
    app_build_id,
    channel,
    ARRAY_CONCAT_AGG(ARRAY<STRUCT<
        metric STRING,
        metric_type STRING,
        key STRING,
        agg_type STRING,
        value FLOAT64
    >>
        [
            (metric, 'keyed-scalar', key, 'max', max),
            (metric, 'keyed-scalar', key, 'min', min),
            (metric, 'keyed-scalar', key, 'avg', avg),
            (metric, 'keyed-scalar', key, 'sum', sum)
        ]
) AS scalar_aggregates
from windowed
where _n = 1
group by 1,2,3,4,5,6
