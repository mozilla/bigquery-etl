[funnels]

[funnels.funnel1]

friendly_name = "Start Subscription Funnel"
description = "Funnel from Signup to starting a subscription"
steps = ["signup", "verify", "start_subscription"]

[funnels.funnel2]
friendly_name = "Subscription Error Funnel"
description = "Funnel from Signup to running into an error"
steps = ["signup", "verify", "error_subscription"]


[steps]

[steps.signup]
friendly_name = "Sign up"
description = "Sign up for VPN"
data_source = "events"
select_expression = "client_info.client_id"
where_expression = """
    event_name = 'authentication_inapp_step' AND
    `mozfun.map.get_key`(event_extra, 'state') = 'StateVerifyingSessionEmailCode'
"""
depends_on_previous_step = true
aggregation = "count distinct"
join_key = "client_info.client_id"

[steps.verify]
friendly_name = "Verify"
description = "Verify email"
data_source = "events"
select_expression = "client_info.client_id"
where_expression = """
    event_name = 'authentication_inapp_step' AND
    `mozfun.map.get_key`(event_extra, 'state') = 'StateVerifyingSessionEmailCode'
"""
depends_on_previous_step = true
aggregation = "count distinct"
join_key = "client_info.client_id"

[steps.start_subscription]
friendly_name = "Start Subscription"
description = "Start VPN subscription"
data_source = "events"
select_expression = "client_info.client_id"
where_expression = "event_name = 'iap_subscription_started'"
depends_on_previous_step = true
aggregation = "count distinct"
join_key = "client_info.client_id"

[steps.error_subscription]
friendly_name = "Subscription Error"
description = "subscription error"
data_source = "events"
select_expression = "client_info.client_id"
where_expression = "event_name = 'error_alert_shown'"
depends_on_previous_step = true
aggregation = "count"
join_key = "client_info.client_id"


[data_sources]

[data_sources.events]
from_expression = """
    (SELECT * FROM mozdata.mozilla_vpn.events_unnested
    WHERE client_info.app_channel = 'production' AND client_info.os = 'iOS')
"""
submission_date_column = "DATE(submission_timestamp)"
