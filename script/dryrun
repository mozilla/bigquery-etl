#!/usr/bin/env python

import glob
import json
import os.path
import sys
from urllib.request import urlopen, Request

DRY_RUN_URL = 'https://us-central1-moz-fx-data-derived-datasets.cloudfunctions.net/bigquery-etl-dryrun'
exitcode = 0
for sql in glob.glob('sql/*/*.sql'):
    pad = ' ' * (60 - len(sql))
    try:
        print(sql, end=pad)
        r = urlopen(
            Request(
                DRY_RUN_URL,
                headers = {
                    'Content-Type': 'application/json'
                },
                data=json.dumps({
                    'dataset': os.path.basename(os.path.dirname(sql)),
                    'query': open(sql).read(),
                }).encode('utf8'),
                method='POST'
            ))
    except Exception as e:
        print('ERROR\n', e)
        exitcode = 1
    else:
        response = json.load(r)
        if response['valid']:
            print('OK')
        else:
            print('ERROR\n', response['errors'])
            exitcode = 1

sys.exit(exitcode)
