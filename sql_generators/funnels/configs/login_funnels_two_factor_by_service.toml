destination_dataset = "firefox_accounts_derived"
platform = "firefox_accounts"
owners = ["ksiegler@mozilla.org"]  # optional; users getting notification if funnel run fails
version = "1"  # optional; default is set to 1
start_date = "2024-01-01"

[funnels]

[funnels.login_success_with_2fa_by_service]

friendly_name = "Login Funnel Conversion with 2FA Step by Service"
description = "Funnel steps from Login View through 2FA (no backup codes) by Service"
steps = ["login_view", "login_submit", "login_success", "login_two_factor_view", "login_two_factor_submit", "login_two_factor_success", "login_complete"]
dimensions = ["service"]

[steps]

[steps.login_view]
friendly_name = "Login View Form"
description = "View of the top of the login funnel"
data_source = "monitor_frontend"
select_expression = "metrics.string.session_flow_id"
where_expression = "metrics.string.event_name = 'login_view'"
aggregation = "count distinct"
join_previous_step_on = "metrics.string.session_flow_id"

[steps.login_submit]
friendly_name = "Successful Login Submission"
description = "The login form was attempted to be submitted"
data_source = "monitor_frontend"
select_expression = "metrics.string.session_flow_id"
where_expression = "metrics.string.event_name = 'login_submit'"
aggregation = "count distinct"
join_previous_step_on = "metrics.string.session_flow_id"

[steps.login_success]
friendly_name = "Successful Password Submission"
description = "The login form was submitted successfully"
data_source = "monitor_backend"
select_expression = "metrics.string.session_flow_id"
where_expression = "metrics.string.event_name = 'login_success'"
aggregation = "count distinct"
join_previous_step_on = "metrics.string.session_flow_id"

[steps.login_two_factor_view]
friendly_name = "Login 2FA Form"
description = "View of the login 2FA form"
data_source = "monitor_frontend"
select_expression = "metrics.string.session_flow_id"
where_expression = "metrics.string.event_name = 'login_totp_form_view'"
aggregation = "count distinct"
join_previous_step_on = "metrics.string.session_flow_id"

[steps.login_two_factor_submit]
friendly_name = "Attempt to submit login 2FA form"
description = "The user successfully authenticated through 2FA"
data_source = "monitor_frontend"
select_expression = "metrics.string.session_flow_id"
where_expression = "metrics.string.event_name = 'login_totp_code_submit'"
aggregation = "count distinct"
join_previous_step_on = "metrics.string.session_flow_id"

[steps.login_two_factor_success]
friendly_name = "Login 2FA Success"
description = "Successful submission of 2FA form"
data_source = "monitor_frontend"
select_expression = "metrics.string.session_flow_id"
where_expression = "metrics.string.event_name = 'login_totp_code_success_view'"
aggregation = "count distinct"
join_previous_step_on = "metrics.string.session_flow_id"

[steps.login_complete]
friendly_name = "Successful Login Completion"
description = "The login flow was completed successfully"
data_source = "monitor_backend"
select_expression = "metrics.string.session_flow_id"
where_expression = "metrics.string.event_name = 'login_complete'"
aggregation = "count distinct"
join_previous_step_on = "metrics.string.session_flow_id"

[data_sources]

[data_sources.monitor_frontend]
from_expression = "mozdata.accounts_frontend.accounts_events"
submission_date_column = "DATE(submission_timestamp)"
client_id_column = "client_info.client_id"

[data_sources.monitor_backend]
from_expression = "mozdata.accounts_backend.accounts_events"
submission_date_column = "DATE(submission_timestamp)"
client_id_column = "client_info.client_id"


[dimensions]

[dimensions.service]
data_source = "monitor_frontend"
select_expression = "IF(COALESCE(NULLIF(metrics.string.relying_party_oauth_client_id, ''), NULLIF(metrics.string.relying_party_service, '')) = 'sync', '5882386c6d801776', COALESCE(NULLIF(metrics.string.relying_party_oauth_client_id, ''), NULLIF(metrics.string.relying_party_service, '')))"
friendly_name = "Service"
description = "Oauth Client ID is used to map to service name for which service the user logged in through"
client_id_column = "client_info.client_id"