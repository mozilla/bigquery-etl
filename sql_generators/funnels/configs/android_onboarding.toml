destination_dataset = "fenix_derived"
platform = "fenix"
owners = ["loines@mozilla.org"]  # optional; users getting notification if funnel run fails
version = "1"  # optional; default is set to 1

[funnels]

[funnels.onboarding_funnel]

friendly_name = "Start Subscription Funnel"
description = "Funnel from Signup to starting a subscription"
steps = ["first_card", "second_card", "third_card", "onboarding_completed"]
dimensions = ["funnel_id", "action", "element_type"]


[steps]

[steps.first_card]
friendly_name = "First Card"
description = "First Onboarding Card"
data_source = "onboarding_events"
where_expression = """
    `mozfun.map.get_key`(event_extra, 'sequence_position') = '1' AND
    event_name != 'completed' AND
    event_category = 'onboarding'

"""
join_previous_step_on = "client_info.client_id"
select_expression = "client_info.client_id"
aggregation = "count distinct"

[steps.second_card]
friendly_name = "Second Card"
description = "Impression on Second Onboarding Card"
data_source = "onboarding_events"
where_expression = """
    `mozfun.map.get_key`(event_extra, 'sequence_position') = '2' AND
    event_name != 'completed' AND
    event_category = 'onboarding'
"""
join_previous_step_on = "client_info.client_id"
select_expression = "client_info.client_id"
aggregation = "count distinct"

[steps.third_card]
friendly_name = "Third Card"
description = "Third Onboarding Card"
data_source = "onboarding_events"
where_expression = """
    `mozfun.map.get_key`(event_extra, 'sequence_position') = '3' AND
    event_name != 'completed' AND
    event_category = 'onboarding'
"""
join_previous_step_on = "client_info.client_id"
select_expression = "client_info.client_id"
aggregation = "count distinct"

[steps.onboarding_completed]
friendly_name = "Third Card"
description = "Third Onboarding Card"
data_source = "onboarding_events"
where_expression = """
    event_name = 'completed' AND
    event_category = 'onboarding'
"""
join_previous_step_on = "client_info.client_id"
select_expression = "client_info.client_id"
aggregation = "count distinct"

[data_sources]

[data_sources.onboarding_events]
from_expression = """
  fenix.events_unnested
"""
submission_date_column = "DATE(submission_timestamp)"
client_id_column = "client_info.client_id"


[dimensions]

[dimensions.action]
data_source = "onboarding_events"
select_expression = "`mozfun.map.get_key`(event_extra, 'action')"
friendly_name = "Card Action"
description = "Action Taken on Card"
client_id_column = "client_info.client_id"

[dimensions.funnel_id]
data_source = "onboarding_events"
select_expression = "`mozfun.map.get_key`(event_extra, 'sequence_id')"
friendly_name = "Funnel ID"
description = "ID of the Onboarding Funnel"
client_id_column = "client_info.client_id"

[dimensions.element_type]
data_source = "onboarding_events"
select_expression = "`mozfun.map.get_key`(event_extra, 'element_type')"
friendly_name = "Element Type"
description = "Type of Card Element Interacted With"
client_id_column = "client_info.client_id"

[dimensions.country]
data_source = "onboarding_events"
select_expression = "normalized_country_code"
friendly_name = "Country"
description = "normed country code"
client_id_column = "client_info.client_id"
