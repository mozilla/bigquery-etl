-- Generated by bqetl generate firefox_crashes
WITH
  -- get past minidump hashes to remove duplicates from current day
  -- keep all empty and null minidumps
past_minidumps AS (
  SELECT
    metrics.string.crash_minidump_sha256_hash AS past_minidump_hash
  FROM
    `moz-fx-data-shared-prod.firefox_desktop.crash`
  WHERE
    DATE(submission_timestamp)
    BETWEEN DATE_SUB(@submission_date, INTERVAL 365 DAY)
    AND DATE_SUB(@submission_date, INTERVAL 1 DAY)
        -- hash of empty dump
    AND metrics.string.crash_minidump_sha256_hash != 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855'
    AND metrics.string.crash_minidump_sha256_hash IS NOT NULL
  UNION ALL
  SELECT
    metrics.string.crash_minidump_sha256_hash AS past_minidump_hash
  FROM
    `moz-fx-data-shared-prod.firefox_crashreporter.crash`
  WHERE
    DATE(submission_timestamp)
    BETWEEN DATE_SUB(@submission_date, INTERVAL 365 DAY)
    AND DATE_SUB(@submission_date, INTERVAL 1 DAY)
        -- hash of empty dump
    AND metrics.string.crash_minidump_sha256_hash != 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855'
    AND metrics.string.crash_minidump_sha256_hash IS NOT NULL
  UNION ALL
  SELECT
    metrics.string.crash_minidump_sha256_hash AS past_minidump_hash
  FROM
    `moz-fx-data-shared-prod.fenix.crash`
  WHERE
    DATE(submission_timestamp)
    BETWEEN DATE_SUB(@submission_date, INTERVAL 365 DAY)
    AND DATE_SUB(@submission_date, INTERVAL 1 DAY)
        -- hash of empty dump
    AND metrics.string.crash_minidump_sha256_hash != 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855'
    AND metrics.string.crash_minidump_sha256_hash IS NOT NULL
  UNION ALL
  SELECT
    metrics.string.crash_minidump_sha256_hash AS past_minidump_hash
  FROM
    `moz-fx-data-shared-prod.focus_android.crash`
  WHERE
    DATE(submission_timestamp)
    BETWEEN DATE_SUB(@submission_date, INTERVAL 365 DAY)
    AND DATE_SUB(@submission_date, INTERVAL 1 DAY)
        -- hash of empty dump
    AND metrics.string.crash_minidump_sha256_hash != 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855'
    AND metrics.string.crash_minidump_sha256_hash IS NOT NULL
  UNION ALL
  SELECT
    metrics.string.crash_minidump_sha256_hash AS past_minidump_hash
  FROM
    `moz-fx-data-shared-prod.klar_android.crash`
  WHERE
    DATE(submission_timestamp)
    BETWEEN DATE_SUB(@submission_date, INTERVAL 365 DAY)
    AND DATE_SUB(@submission_date, INTERVAL 1 DAY)
        -- hash of empty dump
    AND metrics.string.crash_minidump_sha256_hash != 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855'
    AND metrics.string.crash_minidump_sha256_hash IS NOT NULL
),
past_minidumps_deduped AS (
  SELECT DISTINCT
    (past_minidump_hash) AS past_minidump_hash
  FROM
    past_minidumps
),
unioned_pings AS (
  SELECT
    additional_properties,
    client_info,
    document_id,
    events,
    metadata,
    STRUCT(
      metrics.labeled_counter,
      metrics.boolean,
      metrics.datetime,
      STRUCT(
        metrics.string.crash_process_type,
        metrics.string.glean_client_annotation_experimentation_id,
        metrics.string.crash_app_build,
        metrics.string.crash_app_channel,
        metrics.string.crash_app_display_version,
        metrics.string.crash_background_task_name,
        metrics.string.crash_font_name,
        metrics.string.crash_ipc_channel_error,
        metrics.string.crash_main_thread_runnable_name,
        metrics.string.crash_minidump_sha256_hash,
        metrics.string.crash_moz_crash_reason,
        metrics.string.crash_profiler_child_shutdown_phase,
        metrics.string.crash_remote_type,
        metrics.string.crash_shutdown_progress,
        metrics.string.crash_windows_file_dialog_error_code,
        metrics.string.windows_package_family_name,
        metrics.string.memory_js_large_allocation_failure,
        metrics.string.memory_js_out_of_memory,
        CAST(NULL AS STRING) AS `crash_cause`
      ) AS `string`,
      metrics.timespan,
      STRUCT(
        metrics.object.crash_async_shutdown_timeout,
        metrics.object.crash_quota_manager_shutdown_timeout,
        metrics.object.crash_stack_traces,
        CAST(NULL AS JSON) AS `crash_breadcrumbs`,
        CAST(NULL AS JSON) AS `crash_java_exception`
      ) AS `object`,
      metrics.quantity,
      metrics.string_list
    ) AS `metrics`,
    normalized_app_name,
    normalized_channel,
    normalized_country_code,
    normalized_os,
    normalized_os_version,
    ping_info,
    sample_id,
    submission_timestamp,
    app_version_major,
    app_version_minor,
    app_version_patch,
    is_bot_generated,
    CAST(NULL AS STRING) AS `normalized_app_id`,
  FROM
    `moz-fx-data-shared-prod.firefox_desktop.crash`
  UNION ALL
  SELECT
    additional_properties,
    STRUCT(
      client_info.android_sdk_version,
      client_info.app_build,
      client_info.app_channel,
      client_info.app_display_version,
      client_info.architecture,
      client_info.build_date,
      client_info.client_id,
      client_info.device_manufacturer,
      client_info.device_model,
      client_info.first_run_date,
      client_info.locale,
      client_info.os,
      client_info.os_version,
      client_info.telemetry_sdk_build,
      client_info.windows_build_number,
      client_info.session_count,
      client_info.session_id,
      client_info.attribution,
      client_info.distribution
    ) AS `client_info`,
    document_id,
    events,
    metadata,
    STRUCT(
      metrics.labeled_counter,
      STRUCT(
        metrics.boolean.crash_startup,
        metrics.boolean.crash_is_garbage_collecting,
        metrics.boolean.crash_windows_error_reporting,
        metrics.boolean.dll_blocklist_init_failed,
        metrics.boolean.dll_blocklist_user32_loaded_before,
        metrics.boolean.environment_headless_mode
      ) AS `boolean`,
      metrics.datetime,
      STRUCT(
        metrics.string.crash_process_type,
        metrics.string.glean_client_annotation_experimentation_id,
        metrics.string.crash_app_build,
        metrics.string.crash_app_channel,
        metrics.string.crash_app_display_version,
        metrics.string.crash_background_task_name,
        metrics.string.crash_font_name,
        metrics.string.crash_ipc_channel_error,
        metrics.string.crash_main_thread_runnable_name,
        metrics.string.crash_minidump_sha256_hash,
        metrics.string.crash_moz_crash_reason,
        metrics.string.crash_profiler_child_shutdown_phase,
        metrics.string.crash_remote_type,
        metrics.string.crash_shutdown_progress,
        metrics.string.crash_windows_file_dialog_error_code,
        metrics.string.windows_package_family_name,
        metrics.string.memory_js_large_allocation_failure,
        metrics.string.memory_js_out_of_memory,
        CAST(NULL AS STRING) AS `crash_cause`
      ) AS `string`,
      STRUCT(
        CAST(NULL AS STRUCT<`time_unit` STRING, `value` INTEGER>) AS `crash_uptime`,
        metrics.timespan.environment_uptime
      ) AS `timespan`,
      STRUCT(
        metrics.object.crash_async_shutdown_timeout,
        metrics.object.crash_quota_manager_shutdown_timeout,
        metrics.object.crash_stack_traces,
        CAST(NULL AS JSON) AS `crash_breadcrumbs`,
        CAST(NULL AS JSON) AS `crash_java_exception`
      ) AS `object`,
      metrics.quantity,
      metrics.string_list
    ) AS `metrics`,
    normalized_app_name,
    normalized_channel,
    normalized_country_code,
    normalized_os,
    normalized_os_version,
    STRUCT(
      ping_info.end_time,
      ARRAY(
        SELECT
          STRUCT(
            experiments.key,
            STRUCT(
              experiments.value.branch,
              STRUCT(experiments.value.extra.type, experiments.value.extra.enrollment_id) AS `extra`
            ) AS `value`
          )
        FROM
          UNNEST(ping_info.experiments) AS `experiments`
      ) AS `experiments`,
      ping_info.ping_type,
      ping_info.reason,
      ping_info.seq,
      ping_info.start_time,
      ping_info.parsed_start_time,
      ping_info.parsed_end_time
    ) AS `ping_info`,
    sample_id,
    submission_timestamp,
    app_version_major,
    app_version_minor,
    app_version_patch,
    is_bot_generated,
    CAST(NULL AS STRING) AS `normalized_app_id`,
  FROM
    `moz-fx-data-shared-prod.firefox_crashreporter.crash`
  UNION ALL
  SELECT
    additional_properties,
    STRUCT(
      client_info.android_sdk_version,
      client_info.app_build,
      client_info.app_channel,
      client_info.app_display_version,
      client_info.architecture,
      client_info.build_date,
      client_info.client_id,
      client_info.device_manufacturer,
      client_info.device_model,
      client_info.first_run_date,
      client_info.locale,
      client_info.os,
      client_info.os_version,
      client_info.telemetry_sdk_build,
      client_info.windows_build_number,
      client_info.session_count,
      client_info.session_id,
      STRUCT(
        client_info.attribution.campaign,
        client_info.attribution.content,
        client_info.attribution.medium,
        client_info.attribution.source,
        client_info.attribution.term,
        client_info.attribution.ext
      ) AS `attribution`,
      STRUCT(client_info.distribution.name, client_info.distribution.ext) AS `distribution`
    ) AS `client_info`,
    document_id,
    ARRAY(
      SELECT
        STRUCT(
          events.category,
          ARRAY(
            SELECT
              STRUCT(extra.key, extra.value)
            FROM
              UNNEST(events.extra) AS `extra`
          ) AS `extra`,
          events.name,
          events.timestamp
        )
      FROM
        UNNEST(events) AS `events`
    ) AS `events`,
    STRUCT(
      STRUCT(
        metadata.geo.city,
        metadata.geo.country,
        metadata.geo.db_version,
        metadata.geo.subdivision1,
        metadata.geo.subdivision2
      ) AS `geo`,
      STRUCT(
        metadata.header.date,
        metadata.header.dnt,
        metadata.header.x_debug_id,
        metadata.header.x_foxsec_ip_reputation,
        metadata.header.x_lb_tags,
        metadata.header.x_pingsender_version,
        metadata.header.x_source_tags,
        metadata.header.x_telemetry_agent,
        metadata.header.parsed_date,
        metadata.header.parsed_x_source_tags,
        STRUCT(
          metadata.header.parsed_x_lb_tags.tls_version,
          metadata.header.parsed_x_lb_tags.tls_cipher_hex
        ) AS `parsed_x_lb_tags`
      ) AS `header`,
      STRUCT(metadata.isp.db_version, metadata.isp.name, metadata.isp.organization) AS `isp`,
      STRUCT(
        metadata.user_agent.browser,
        metadata.user_agent.os,
        metadata.user_agent.version
      ) AS `user_agent`
    ) AS `metadata`,
    STRUCT(
      STRUCT(
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_label.key, glean_error_invalid_label.value)
          FROM
            UNNEST(metrics.labeled_counter.glean_error_invalid_label) AS `glean_error_invalid_label`
        ) AS `glean_error_invalid_label`,
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_overflow.key, glean_error_invalid_overflow.value)
          FROM
            UNNEST(
              metrics.labeled_counter.glean_error_invalid_overflow
            ) AS `glean_error_invalid_overflow`
        ) AS `glean_error_invalid_overflow`,
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_state.key, glean_error_invalid_state.value)
          FROM
            UNNEST(metrics.labeled_counter.glean_error_invalid_state) AS `glean_error_invalid_state`
        ) AS `glean_error_invalid_state`,
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_value.key, glean_error_invalid_value.value)
          FROM
            UNNEST(metrics.labeled_counter.glean_error_invalid_value) AS `glean_error_invalid_value`
        ) AS `glean_error_invalid_value`
      ) AS `labeled_counter`,
      STRUCT(
        metrics.boolean.crash_startup,
        metrics.boolean.crash_is_garbage_collecting,
        CAST(NULL AS BOOLEAN) AS `crash_windows_error_reporting`,
        CAST(NULL AS BOOLEAN) AS `dll_blocklist_init_failed`,
        CAST(NULL AS BOOLEAN) AS `dll_blocklist_user32_loaded_before`,
        metrics.boolean.environment_headless_mode
      ) AS `boolean`,
      STRUCT(metrics.datetime.crash_time, metrics.datetime.raw_crash_time) AS `datetime`,
      STRUCT(
        metrics.string.crash_process_type,
        metrics.string.glean_client_annotation_experimentation_id,
        metrics.string.crash_app_build,
        metrics.string.crash_app_channel,
        metrics.string.crash_app_display_version,
        metrics.string.crash_background_task_name,
        metrics.string.crash_font_name,
        metrics.string.crash_ipc_channel_error,
        metrics.string.crash_main_thread_runnable_name,
        metrics.string.crash_minidump_sha256_hash,
        metrics.string.crash_moz_crash_reason,
        metrics.string.crash_profiler_child_shutdown_phase,
        metrics.string.crash_remote_type,
        metrics.string.crash_shutdown_progress,
        CAST(NULL AS STRING) AS `crash_windows_file_dialog_error_code`,
        CAST(NULL AS STRING) AS `windows_package_family_name`,
        metrics.string.memory_js_large_allocation_failure,
        metrics.string.memory_js_out_of_memory,
        metrics.string.crash_cause
      ) AS `string`,
      STRUCT(
        STRUCT(
          metrics.timespan.crash_uptime.time_unit,
          metrics.timespan.crash_uptime.value
        ) AS `crash_uptime`,
        STRUCT(
          metrics.timespan.environment_uptime.time_unit,
          metrics.timespan.environment_uptime.value
        ) AS `environment_uptime`
      ) AS `timespan`,
      STRUCT(
        metrics.object.crash_async_shutdown_timeout,
        metrics.object.crash_quota_manager_shutdown_timeout,
        metrics.object.crash_stack_traces,
        metrics.object.crash_breadcrumbs,
        metrics.object.crash_java_exception
      ) AS `object`,
      STRUCT(
        metrics.quantity.crash_event_loop_nesting_level,
        metrics.quantity.crash_gpu_process_launch,
        metrics.quantity.memory_available_commit,
        metrics.quantity.memory_available_physical,
        metrics.quantity.memory_available_swap,
        metrics.quantity.memory_available_virtual,
        metrics.quantity.memory_low_physical,
        metrics.quantity.memory_oom_allocation_size,
        metrics.quantity.memory_purgeable_physical,
        metrics.quantity.memory_system_use_percentage,
        metrics.quantity.memory_texture,
        metrics.quantity.memory_total_page_file,
        metrics.quantity.memory_total_physical,
        metrics.quantity.memory_total_virtual
      ) AS `quantity`,
      STRUCT(
        CAST(NULL AS ARRAY<STRING>) AS `dll_blocklist_list`,
        metrics.string_list.environment_experimental_features,
        CAST(NULL AS ARRAY<STRING>) AS `crash_utility_actors_name`,
        CAST(NULL AS ARRAY<STRING>) AS `environment_nimbus_enrollments`,
        metrics.string_list.glean_ping_uploader_capabilities
      ) AS `string_list`
    ) AS `metrics`,
    normalized_app_name,
    normalized_channel,
    normalized_country_code,
    normalized_os,
    normalized_os_version,
    STRUCT(
      ping_info.end_time,
      ARRAY(
        SELECT
          STRUCT(
            experiments.key,
            STRUCT(
              experiments.value.branch,
              STRUCT(experiments.value.extra.type, experiments.value.extra.enrollment_id) AS `extra`
            ) AS `value`
          )
        FROM
          UNNEST(ping_info.experiments) AS `experiments`
      ) AS `experiments`,
      ping_info.ping_type,
      ping_info.reason,
      ping_info.seq,
      ping_info.start_time,
      ping_info.parsed_start_time,
      ping_info.parsed_end_time
    ) AS `ping_info`,
    sample_id,
    submission_timestamp,
    app_version_major,
    app_version_minor,
    app_version_patch,
    is_bot_generated,
    normalized_app_id,
  FROM
    `moz-fx-data-shared-prod.fenix.crash`
  UNION ALL
  SELECT
    additional_properties,
    STRUCT(
      client_info.android_sdk_version,
      client_info.app_build,
      client_info.app_channel,
      client_info.app_display_version,
      client_info.architecture,
      client_info.build_date,
      client_info.client_id,
      client_info.device_manufacturer,
      client_info.device_model,
      client_info.first_run_date,
      client_info.locale,
      client_info.os,
      client_info.os_version,
      client_info.telemetry_sdk_build,
      client_info.windows_build_number,
      client_info.session_count,
      client_info.session_id,
      STRUCT(
        client_info.attribution.campaign,
        client_info.attribution.content,
        client_info.attribution.medium,
        client_info.attribution.source,
        client_info.attribution.term,
        client_info.attribution.ext
      ) AS `attribution`,
      STRUCT(client_info.distribution.name, client_info.distribution.ext) AS `distribution`
    ) AS `client_info`,
    document_id,
    ARRAY(
      SELECT
        STRUCT(
          events.category,
          ARRAY(
            SELECT
              STRUCT(extra.key, extra.value)
            FROM
              UNNEST(events.extra) AS `extra`
          ) AS `extra`,
          events.name,
          events.timestamp
        )
      FROM
        UNNEST(events) AS `events`
    ) AS `events`,
    STRUCT(
      STRUCT(
        metadata.geo.city,
        metadata.geo.country,
        metadata.geo.db_version,
        metadata.geo.subdivision1,
        metadata.geo.subdivision2
      ) AS `geo`,
      STRUCT(
        metadata.header.date,
        metadata.header.dnt,
        metadata.header.x_debug_id,
        metadata.header.x_foxsec_ip_reputation,
        metadata.header.x_lb_tags,
        metadata.header.x_pingsender_version,
        metadata.header.x_source_tags,
        metadata.header.x_telemetry_agent,
        metadata.header.parsed_date,
        metadata.header.parsed_x_source_tags,
        STRUCT(
          metadata.header.parsed_x_lb_tags.tls_version,
          metadata.header.parsed_x_lb_tags.tls_cipher_hex
        ) AS `parsed_x_lb_tags`
      ) AS `header`,
      STRUCT(metadata.isp.db_version, metadata.isp.name, metadata.isp.organization) AS `isp`,
      STRUCT(
        metadata.user_agent.browser,
        metadata.user_agent.os,
        metadata.user_agent.version
      ) AS `user_agent`
    ) AS `metadata`,
    STRUCT(
      STRUCT(
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_label.key, glean_error_invalid_label.value)
          FROM
            UNNEST(metrics.labeled_counter.glean_error_invalid_label) AS `glean_error_invalid_label`
        ) AS `glean_error_invalid_label`,
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_overflow.key, glean_error_invalid_overflow.value)
          FROM
            UNNEST(
              metrics.labeled_counter.glean_error_invalid_overflow
            ) AS `glean_error_invalid_overflow`
        ) AS `glean_error_invalid_overflow`,
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_state.key, glean_error_invalid_state.value)
          FROM
            UNNEST(metrics.labeled_counter.glean_error_invalid_state) AS `glean_error_invalid_state`
        ) AS `glean_error_invalid_state`,
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_value.key, glean_error_invalid_value.value)
          FROM
            UNNEST(metrics.labeled_counter.glean_error_invalid_value) AS `glean_error_invalid_value`
        ) AS `glean_error_invalid_value`
      ) AS `labeled_counter`,
      STRUCT(
        metrics.boolean.crash_startup,
        metrics.boolean.crash_is_garbage_collecting,
        CAST(NULL AS BOOLEAN) AS `crash_windows_error_reporting`,
        CAST(NULL AS BOOLEAN) AS `dll_blocklist_init_failed`,
        CAST(NULL AS BOOLEAN) AS `dll_blocklist_user32_loaded_before`,
        metrics.boolean.environment_headless_mode
      ) AS `boolean`,
      STRUCT(metrics.datetime.crash_time, metrics.datetime.raw_crash_time) AS `datetime`,
      STRUCT(
        metrics.string.crash_process_type,
        metrics.string.glean_client_annotation_experimentation_id,
        metrics.string.crash_app_build,
        metrics.string.crash_app_channel,
        metrics.string.crash_app_display_version,
        metrics.string.crash_background_task_name,
        metrics.string.crash_font_name,
        metrics.string.crash_ipc_channel_error,
        metrics.string.crash_main_thread_runnable_name,
        metrics.string.crash_minidump_sha256_hash,
        metrics.string.crash_moz_crash_reason,
        metrics.string.crash_profiler_child_shutdown_phase,
        metrics.string.crash_remote_type,
        metrics.string.crash_shutdown_progress,
        CAST(NULL AS STRING) AS `crash_windows_file_dialog_error_code`,
        CAST(NULL AS STRING) AS `windows_package_family_name`,
        metrics.string.memory_js_large_allocation_failure,
        metrics.string.memory_js_out_of_memory,
        metrics.string.crash_cause
      ) AS `string`,
      STRUCT(
        STRUCT(
          metrics.timespan.crash_uptime.time_unit,
          metrics.timespan.crash_uptime.value
        ) AS `crash_uptime`,
        STRUCT(
          metrics.timespan.environment_uptime.time_unit,
          metrics.timespan.environment_uptime.value
        ) AS `environment_uptime`
      ) AS `timespan`,
      STRUCT(
        metrics.object.crash_async_shutdown_timeout,
        metrics.object.crash_quota_manager_shutdown_timeout,
        metrics.object.crash_stack_traces,
        metrics.object.crash_breadcrumbs,
        metrics.object.crash_java_exception
      ) AS `object`,
      STRUCT(
        metrics.quantity.crash_event_loop_nesting_level,
        metrics.quantity.crash_gpu_process_launch,
        metrics.quantity.memory_available_commit,
        metrics.quantity.memory_available_physical,
        metrics.quantity.memory_available_swap,
        metrics.quantity.memory_available_virtual,
        metrics.quantity.memory_low_physical,
        metrics.quantity.memory_oom_allocation_size,
        metrics.quantity.memory_purgeable_physical,
        metrics.quantity.memory_system_use_percentage,
        metrics.quantity.memory_texture,
        metrics.quantity.memory_total_page_file,
        metrics.quantity.memory_total_physical,
        metrics.quantity.memory_total_virtual
      ) AS `quantity`,
      STRUCT(
        CAST(NULL AS ARRAY<STRING>) AS `dll_blocklist_list`,
        metrics.string_list.environment_experimental_features,
        CAST(NULL AS ARRAY<STRING>) AS `crash_utility_actors_name`,
        CAST(NULL AS ARRAY<STRING>) AS `environment_nimbus_enrollments`,
        metrics.string_list.glean_ping_uploader_capabilities
      ) AS `string_list`
    ) AS `metrics`,
    normalized_app_name,
    normalized_channel,
    normalized_country_code,
    normalized_os,
    normalized_os_version,
    STRUCT(
      ping_info.end_time,
      ARRAY(
        SELECT
          STRUCT(
            experiments.key,
            STRUCT(
              experiments.value.branch,
              STRUCT(experiments.value.extra.type, experiments.value.extra.enrollment_id) AS `extra`
            ) AS `value`
          )
        FROM
          UNNEST(ping_info.experiments) AS `experiments`
      ) AS `experiments`,
      ping_info.ping_type,
      ping_info.reason,
      ping_info.seq,
      ping_info.start_time,
      ping_info.parsed_start_time,
      ping_info.parsed_end_time
    ) AS `ping_info`,
    sample_id,
    submission_timestamp,
    app_version_major,
    app_version_minor,
    app_version_patch,
    is_bot_generated,
    normalized_app_id,
  FROM
    `moz-fx-data-shared-prod.focus_android.crash`
  UNION ALL
  SELECT
    additional_properties,
    STRUCT(
      client_info.android_sdk_version,
      client_info.app_build,
      client_info.app_channel,
      client_info.app_display_version,
      client_info.architecture,
      client_info.build_date,
      client_info.client_id,
      client_info.device_manufacturer,
      client_info.device_model,
      client_info.first_run_date,
      client_info.locale,
      client_info.os,
      client_info.os_version,
      client_info.telemetry_sdk_build,
      client_info.windows_build_number,
      client_info.session_count,
      client_info.session_id,
      STRUCT(
        client_info.attribution.campaign,
        client_info.attribution.content,
        client_info.attribution.medium,
        client_info.attribution.source,
        client_info.attribution.term,
        client_info.attribution.ext
      ) AS `attribution`,
      STRUCT(client_info.distribution.name, client_info.distribution.ext) AS `distribution`
    ) AS `client_info`,
    document_id,
    ARRAY(
      SELECT
        STRUCT(
          events.category,
          ARRAY(
            SELECT
              STRUCT(extra.key, extra.value)
            FROM
              UNNEST(events.extra) AS `extra`
          ) AS `extra`,
          events.name,
          events.timestamp
        )
      FROM
        UNNEST(events) AS `events`
    ) AS `events`,
    STRUCT(
      STRUCT(
        metadata.geo.city,
        metadata.geo.country,
        metadata.geo.db_version,
        metadata.geo.subdivision1,
        metadata.geo.subdivision2
      ) AS `geo`,
      STRUCT(
        metadata.header.date,
        metadata.header.dnt,
        metadata.header.x_debug_id,
        metadata.header.x_foxsec_ip_reputation,
        metadata.header.x_lb_tags,
        metadata.header.x_pingsender_version,
        metadata.header.x_source_tags,
        metadata.header.x_telemetry_agent,
        metadata.header.parsed_date,
        metadata.header.parsed_x_source_tags,
        STRUCT(
          metadata.header.parsed_x_lb_tags.tls_version,
          metadata.header.parsed_x_lb_tags.tls_cipher_hex
        ) AS `parsed_x_lb_tags`
      ) AS `header`,
      STRUCT(metadata.isp.db_version, metadata.isp.name, metadata.isp.organization) AS `isp`,
      STRUCT(
        metadata.user_agent.browser,
        metadata.user_agent.os,
        metadata.user_agent.version
      ) AS `user_agent`
    ) AS `metadata`,
    STRUCT(
      STRUCT(
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_label.key, glean_error_invalid_label.value)
          FROM
            UNNEST(metrics.labeled_counter.glean_error_invalid_label) AS `glean_error_invalid_label`
        ) AS `glean_error_invalid_label`,
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_overflow.key, glean_error_invalid_overflow.value)
          FROM
            UNNEST(
              metrics.labeled_counter.glean_error_invalid_overflow
            ) AS `glean_error_invalid_overflow`
        ) AS `glean_error_invalid_overflow`,
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_state.key, glean_error_invalid_state.value)
          FROM
            UNNEST(metrics.labeled_counter.glean_error_invalid_state) AS `glean_error_invalid_state`
        ) AS `glean_error_invalid_state`,
        ARRAY(
          SELECT
            STRUCT(glean_error_invalid_value.key, glean_error_invalid_value.value)
          FROM
            UNNEST(metrics.labeled_counter.glean_error_invalid_value) AS `glean_error_invalid_value`
        ) AS `glean_error_invalid_value`
      ) AS `labeled_counter`,
      STRUCT(
        metrics.boolean.crash_startup,
        metrics.boolean.crash_is_garbage_collecting,
        CAST(NULL AS BOOLEAN) AS `crash_windows_error_reporting`,
        CAST(NULL AS BOOLEAN) AS `dll_blocklist_init_failed`,
        CAST(NULL AS BOOLEAN) AS `dll_blocklist_user32_loaded_before`,
        metrics.boolean.environment_headless_mode
      ) AS `boolean`,
      STRUCT(metrics.datetime.crash_time, metrics.datetime.raw_crash_time) AS `datetime`,
      STRUCT(
        metrics.string.crash_process_type,
        metrics.string.glean_client_annotation_experimentation_id,
        metrics.string.crash_app_build,
        metrics.string.crash_app_channel,
        metrics.string.crash_app_display_version,
        metrics.string.crash_background_task_name,
        metrics.string.crash_font_name,
        metrics.string.crash_ipc_channel_error,
        metrics.string.crash_main_thread_runnable_name,
        metrics.string.crash_minidump_sha256_hash,
        metrics.string.crash_moz_crash_reason,
        metrics.string.crash_profiler_child_shutdown_phase,
        metrics.string.crash_remote_type,
        metrics.string.crash_shutdown_progress,
        CAST(NULL AS STRING) AS `crash_windows_file_dialog_error_code`,
        CAST(NULL AS STRING) AS `windows_package_family_name`,
        metrics.string.memory_js_large_allocation_failure,
        metrics.string.memory_js_out_of_memory,
        metrics.string.crash_cause
      ) AS `string`,
      STRUCT(
        STRUCT(
          metrics.timespan.crash_uptime.time_unit,
          metrics.timespan.crash_uptime.value
        ) AS `crash_uptime`,
        STRUCT(
          metrics.timespan.environment_uptime.time_unit,
          metrics.timespan.environment_uptime.value
        ) AS `environment_uptime`
      ) AS `timespan`,
      STRUCT(
        metrics.object.crash_async_shutdown_timeout,
        metrics.object.crash_quota_manager_shutdown_timeout,
        metrics.object.crash_stack_traces,
        metrics.object.crash_breadcrumbs,
        metrics.object.crash_java_exception
      ) AS `object`,
      STRUCT(
        metrics.quantity.crash_event_loop_nesting_level,
        metrics.quantity.crash_gpu_process_launch,
        metrics.quantity.memory_available_commit,
        metrics.quantity.memory_available_physical,
        metrics.quantity.memory_available_swap,
        metrics.quantity.memory_available_virtual,
        metrics.quantity.memory_low_physical,
        metrics.quantity.memory_oom_allocation_size,
        metrics.quantity.memory_purgeable_physical,
        metrics.quantity.memory_system_use_percentage,
        metrics.quantity.memory_texture,
        metrics.quantity.memory_total_page_file,
        metrics.quantity.memory_total_physical,
        metrics.quantity.memory_total_virtual
      ) AS `quantity`,
      STRUCT(
        CAST(NULL AS ARRAY<STRING>) AS `dll_blocklist_list`,
        metrics.string_list.environment_experimental_features,
        CAST(NULL AS ARRAY<STRING>) AS `crash_utility_actors_name`,
        CAST(NULL AS ARRAY<STRING>) AS `environment_nimbus_enrollments`,
        metrics.string_list.glean_ping_uploader_capabilities
      ) AS `string_list`
    ) AS `metrics`,
    normalized_app_name,
    normalized_channel,
    normalized_country_code,
    normalized_os,
    normalized_os_version,
    STRUCT(
      ping_info.end_time,
      ARRAY(
        SELECT
          STRUCT(
            experiments.key,
            STRUCT(
              experiments.value.branch,
              STRUCT(experiments.value.extra.type, experiments.value.extra.enrollment_id) AS `extra`
            ) AS `value`
          )
        FROM
          UNNEST(ping_info.experiments) AS `experiments`
      ) AS `experiments`,
      ping_info.ping_type,
      ping_info.reason,
      ping_info.seq,
      ping_info.start_time,
      ping_info.parsed_start_time,
      ping_info.parsed_end_time
    ) AS `ping_info`,
    sample_id,
    submission_timestamp,
    app_version_major,
    app_version_minor,
    app_version_patch,
    is_bot_generated,
    normalized_app_id,
  FROM
    `moz-fx-data-shared-prod.klar_android.crash`
)
SELECT
  unioned_pings.*
FROM
  unioned_pings
LEFT JOIN
  past_minidumps_deduped
  ON past_minidump_hash = metrics.string.crash_minidump_sha256_hash
WHERE
  past_minidump_hash IS NULL
  AND DATE(submission_timestamp) = @submission_date
-- dedupe current day
QUALIFY
  metrics.string.crash_minidump_sha256_hash = 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855'
  OR metrics.string.crash_minidump_sha256_hash IS NULL
  OR ROW_NUMBER() OVER (
    PARTITION BY
      metrics.string.crash_minidump_sha256_hash
    ORDER BY
      submission_timestamp
  ) = 1
