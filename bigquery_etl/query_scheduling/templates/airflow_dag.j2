# Generated via query_scheduling/generate_airflow_dags

from airflow import DAG
from airflow.operators.sensors import ExternalTaskSensor
import datetime
from utils.gcp import bigquery_etl_query

default_args = {{ 
    default_args.to_dict() | 
    format_attr("start_date", "format_date") | 
    format_attr("retry_delay", "format_timedelta") 
}}

with DAG('{{ name }}', default_args=default_args{%+ if schedule_interval != None -%}, schedule_interval={{ schedule_interval | format_timedelta | format_schedule_interval }}{%+ endif -%}) as dag:
{% for task in tasks %}
    {{ task.task_name }} = bigquery_etl_query(
        task_id='{{ task.task_name }}',
        destination_table='{{ task.table }}_{{ task.version }}',
        dataset_id='{{ task.dataset }}',
        project_id='moz-fx-data-shared-prod',
        owner='{{ task.owner }}',
        {%+ if task.email | length > 0 -%}
        email={{ task.email | sort }},
        {%+ endif -%}
        {%+ if task.start_date -%}
        start_date={{ task.start_date | format_date }},
        {%+ endif -%}
        {%+ if task.date_partition_parameter == None or task.date_partition_parameter is string -%}
        date_partition_parameter={{ task.date_partition_parameter | format_optional_string }},
        {%+ endif -%}
        depends_on_past={{ task.depends_on_past }},
        dag=dag,
    )
{% endfor -%}

{% set dependencies_seen = [] -%}
{% for task in tasks %}
    {% for dependency in task.dependencies -%}
    {% if dependency.dag_name == name -%}
    {{ task.task_name }}.set_upstream({{ dependency.task_name }})
    {% else -%}
    {% if (dependency.dag_name, dependency.task_name) not in dependencies_seen -%}
    wait_for_{{ dependency.task_name }} = ExternalTaskSensor(
        task_id='wait_for_{{ dependency.task_name }}',
        external_dag_id='{{ dependency.dag_name }}',
        external_task_id='{{ dependency.task_name }}',
    )
    {{ dependencies_seen.append((dependency.dag_name, dependency.task_name)) or "" }}
    {% endif -%}

    {{ task.task_name }}.set_upstream(wait_for_{{ dependency.task_name }})
    {% endif -%}
    {% endfor -%}

    
    {% for task_ref in task.depends_on -%}
    {% if (task_ref.dag_name, task_ref.task_id) not in dependencies_seen -%}
    wait_for_{{ task_ref.dag_name }}_{{ task_ref.task_id }} = ExternalTaskSensor(
        task_id="wait_for_{{ task_ref.dag_name }}_{{ task_ref.task_id }}",
        external_dag_id="{{ task_ref.dag_name }}",
        external_task_id="{{ task_ref.task_id }}",
        {% if task_ref.execution_delta -%}
        execution_delta={{ task_ref.execution_delta | format_timedelta | format_repr }},
        {% endif -%}
        dag=dag,
    )
    {{ dependencies_seen.append((task_ref.dag_name, task_ref.task_id)) or "" }}
    {%+ endif -%}

    {{ task.task_name }}.set_upstream(wait_for_{{ task_ref.dag_name }}_{{ task_ref.task_id }})
    {%+ endfor -%}
{% endfor -%}
