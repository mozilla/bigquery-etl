-- Query for firefox_desktop_derived.desktop_installs_v1
            -- For more information on writing queries see:
            -- https://docs.telemetry.mozilla.org/cookbooks/bigquery/querying.html
WITH download_token_info AS (
  SELECT
    dltoken,
    download_date
  FROM
    `moz-fx-data-marketing-prod.ga_derived.downloads_with_attribution_v1`
),
install_ping AS (
  SELECT
    DATE(submission_timestamp) AS submission_date,
    installer_type,
    version,
    from_msi,
    funnelcake,
    attribution.experiment,
    attribution.variation,
    metadata.isp.name AS nm,
    metadata.isp.organization,
    ping_version,
    attribution.campaign,
    attribution.content,
    attribution.dlsource,
    attribution.dltoken,
    attribution.medium,
    attribution.source,
    attribution.ua,
    metadata.geo.city,
    metadata.geo.country,
    metadata.geo.subdivision1,
    normalized_country_code,
    locale,
    os_version,
    build_channel,
    build_id,
    update_channel,
    had_old_install,
    old_default,
    old_version,
    manual_download,
    silent,
    user_cancelled,
    succeeded,
    profile_cleanup_prompt,
    profile_cleanup_requested,
    new_default,
    new_launched,
    sample_id,
    COUNT(*) AS install_attempts
  FROM
    `moz-fx-data-shared-prod.telemetry.install`
  WHERE
    DATE(submission_timestamp) = @submission_date
  GROUP BY
    submission_date,
    installer_type,
    version,
    from_msi,
    funnelcake,
    attribution.experiment,
    attribution.variation,
    metadata.isp.name,
    metadata.isp.organization,
    ping_version,
    attribution.campaign,
    attribution.content,
    attribution.dlsource,
    attribution.dltoken,
    attribution.medium,
    attribution.source,
    attribution.ua,
    metadata.geo.city,
    metadata.geo.country,
    metadata.geo.subdivision1,
    normalized_country_code,
    locale,
    os_version,
    build_channel,
    build_id,
    update_channel,
    had_old_install,
    old_default,
    old_version,
    manual_download,
    silent,
    user_cancelled,
    succeeded,
    profile_cleanup_prompt,
    profile_cleanup_requested,
    new_default,
    new_launched,
    sample_id
)
SELECT
  install_ping.submission_date,
  install_ping.installer_type,
  install_ping.version,
  install_ping.from_msi,
  install_ping.funnelcake,
  install_ping.experiment,
  install_ping.variation,
  install_ping.nm,
  install_ping.organization,
  install_ping.ping_version,
  install_ping.campaign,
  install_ping.content,
  install_ping.dlsource,
  install_ping.dltoken,
  install_ping.medium,
  install_ping.source,
  install_ping.ua,
  install_ping.city,
  install_ping.country,
  install_ping.subdivision1,
  install_ping.normalized_country_code,
  install_ping.locale,
  install_ping.os_version,
  install_ping.build_channel,
  install_ping.build_id,
  install_ping.update_channel,
  install_ping.had_old_install,
  install_ping.old_default,
  install_ping.old_version,
  install_ping.manual_download,
  install_ping.silent,
  install_ping.user_cancelled,
  install_ping.succeeded,
  install_ping.profile_cleanup_prompt,
  install_ping.profile_cleanup_requested,
  install_ping.new_default,
  install_ping.new_launched,
  install_ping.sample_id,
  install_ping.install_attempts,
  download_token_info.download_date
FROM
  install_ping
LEFT JOIN
  download_token_info
  USING (dltoken)
